     1                                  ;****************************************************************************************************************************
     2                                  ;* Program name: Non-deterministic Random Numbers                                                                           *
     3                                  ;* Copyright (C) 2025 Konner Rigby.                                                                                           *
     4                                  ;* This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License  *
     5                                  ;* version 3 as published by the Free Software Foundation. This program is distributed in the hope that it will be useful,    *
     6                                  ;* but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See    *
     7                                  ;* the GNU General Public License for more details. A copy of the GNU General Public License v3 is available here:            *
     8                                  ;* <https://www.gnu.org/licenses/>.                                                                                         *
     9                                  ;****************************************************************************************************************************
    10                                  ;========1=========2=========3=========4=========5=========6=========7=========8=========9=========0=========1=========2=========3**
    11                                  ; Author information
    12                                  ; Author: Konner Rigby
    13                                  ; Author Email: rigbykonner@csu.fullerton.edu or rigbykonner@gmail.com
    14                                  ; CWID: 884547654
    15                                  ; Class: 240-03 Section 03
    16                                  ;
    17                                  ; This file
    18                                  ;   File name: fill_random_array.asm
    19                                  ;   Function: fill_random_array
    20                                  ;   Purpose: Fills a given array with 'n' valid 64-bit random numbers.
    21                                  ;            It calls isnan to check for NaNs.
    22                                  ;   Language: x86-64 Assembly
    23                                  ;   Syntax: Intel
    24                                  ;   Assembler: nasm -f elf64 -g -o fill_random_array.o fill_random_array.asm
    25                                  ;========1=========2=========3=========4=========5=========6=========7=========8=========9=========0=========1=========2=========3**
    26                                  
    27                                  ; === Declarations ===
    28                                  global fill_random_array
    29                                  extern isnan
    30                                  
    31                                  ; === Uninitialized Data ===
    32                                  segment .bss
    33 00000000 ????????????????            temp_double: resq 1 ; 8-byte scratch space for rax -> xmm0
    34                                  
    35                                  ; === Code ===
    36                                  segment .text
    37                                  fill_random_array:
    38                                      ; === Standard Prologue ===
    39 00000000 55                          push    rbp
    40 00000001 4889E5                      mov     rbp, rsp
    41 00000004 4154                        push    r12             ; Callee-saved register for array base
    42 00000006 4155                        push    r13             ; Callee-saved register for count
    43 00000008 4156                        push    r14             ; Callee-saved register for loop counter
    44                                  
    45                                      ; === Save passed-in values ===
    46 0000000A 4989FC                      mov     r12, rdi        ; r12 = array address
    47 0000000D 4989F5                      mov     r13, rsi        ; r13 = count
    48 00000010 4D31F6                      xor     r14, r14        ; r14 = loop counter i = 0
    49                                  
    50                                  main_fill_loop:
    51                                      ; === Begin main loop to fill array ===
    52 00000013 4D39EE                      cmp     r14, r13        ; Compare i with count
    53 00000016 7D39                        jge     fill_done       ; If i >= count, we are done
    54                                  
    55                                  get_random_num_loop:
    56                                      ; === Obtain a valid random number ===
    57 00000018 480FC7F0                    rdrand  rax             ; Generate 64-bit random number in RAX
    58 0000001C 73FA                        jnc     get_random_num_loop ; If Carry Flag=0, rdrand failed, try again
    59                                  
    60                                      ; === Check if the random number is a NaN ===
    61                                      ; isnan expects the float in XMM0.
    62                                      ; We must move the bits from RAX -> memory -> XMM0
    63                                      
    64 0000001E 48890425[00000000]          mov     [temp_double], rax    ; Store 64-bit integer to memory
    65 00000026 F20F100425-                 movsd   xmm0, [temp_double]   ; Load it into XMM0 (This is an allowed instruction)
    65 0000002B [00000000]         
    66                                      
    67                                      ; Save registers before call
    68 0000002F 50                          push    rax
    69 00000030 4154                        push    r12
    70 00000032 4155                        push    r13
    71 00000034 4156                        push    r14
    72                                      
    73 00000036 E8(00000000)                call    isnan           ; isnan returns 1 in RAX if NaN, 0 otherwise
    74                                      
    75 0000003B 415E                        pop     r14
    76 0000003D 415D                        pop     r13
    77 0000003F 415C                        pop     r12
    78 00000041 59                          pop     rcx             ; Pop original random number (from rax) into RCX
    79                                      
    80 00000042 4883F801                    cmp     rax, 1          ; Did isnan return 1 (true)?
    81 00000046 74D0                        je      get_random_num_loop ; If yes, it was a NaN. Discard and get new number.
    82                                  
    83                                      ; === Store valid number in array ===
    84                                      ; The valid number's bits are in RCX
    85 00000048 4B890CF4                    mov     [r12 + r14 * 8], rcx ; Store the 64-bit number in array[i]
    86                                      
    87 0000004C 49FFC6                      inc     r14             ; i++
    88 0000004F EBC2                        jmp     main_fill_loop
    89                                  
    90                                  fill_done:
    91                                      ; === Standard Epilogue ===
    92 00000051 415E                        pop     r14
    93 00000053 415D                        pop     r13
    94 00000055 415C                        pop     r12
    95 00000057 5D                          pop     rbp
    96 00000058 C3                          ret
