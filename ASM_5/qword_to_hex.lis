     1                                  ;****************************************************************************************************************************
     2                                  ;* Program name: Non-deterministic Random Numbers                                                                           *
     3                                  ;* Copyright (C) 2025 Konner Rigby.                                                                                           *
     4                                  ;* This file is part of the Non-deterministic Random Numbers program.                                                       *
     5                                  ;****************************************************************************************************************************
     6                                  
     7                                  ;========1=========2=========3=========4=========5=========6=========7=========8=========9=========0=========1=========2=========3**
     8                                  ; Author information
     9                                  ; Author: Konner Rigby
    10                                  ;
    11                                  ; This file
    12                                  ;   File name: qword_to_hex.asm
    13                                  ;   Function: qword_to_hex
    14                                  ;   Purpose: Converts a 64-bit integer into a 16-char hex string.
    15                                  ;            Uses only allowed GPR instructions.
    16                                  ;   Language: x86-64 Assembly
    17                                  ;   Syntax: Intel
    18                                  ;   Assembler: nasm -f elf64 -g -o qword_to_hex.o qword_to_hex.asm
    19                                  ;========1=========2=========3=========4=========5=========6=========7=========8=========9=========0=========1=========2=========3**
    20                                  
    21                                  global qword_to_hex
    22                                  
    23                                  segment .data
    24 00000000 303132333435363738-         hex_digits: db "0123456789ABCDEF"
    24 00000009 39414243444546     
    25                                  
    26                                  segment .text
    27                                  qword_to_hex:
    28                                      ; rdi = 64-bit integer to convert
    29                                      ; rsi = pointer to 16-byte buffer
    30                                      
    31 00000000 55                          push    rbp
    32 00000001 4889E5                      mov     rbp, rsp
    33 00000004 4154                        push    r12             ; Save callee-saved register
    34                                      
    35 00000006 4989FC                      mov     r12, rdi        ; r12 = our number
    36 00000009 4889F7                      mov     rdi, rsi        ; rdi = buffer pointer
    37 0000000C 41B910000000                mov     r9, 16          ; r9 = loop counter
    38 00000012 B13C                        mov     cl, 60          ; cl = initial shift amount
    39                                  
    40                                  convert_loop:
    41                                      ; === This logic correctly runs 16 times ===
    42                                      ; It processes the nibble at shift `cl` (60, 56, ..., 4, 0)
    43                                      
    44 00000014 4C89E0                      mov     rax, r12
    45 00000017 48D3E8                      shr     rax, cl         ; Isolate the top nibble
    46 0000001A 4883E00F                    and     rax, 0x0F       ; Mask to get just that nibble
    47                                      
    48 0000001E 4C8D0425[00000000]          lea     r8, [hex_digits]
    49 00000026 418A0400                    mov     al, [r8 + rax]  ; Get the ASCII hex char (using al is allowed)
    50                                      
    51 0000002A 8807                        mov     [rdi], al       ; Store the char in the buffer
    52                                      
    53 0000002C 48FFC7                      inc     rdi             ; Increment buffer pointer
    54 0000002F 80E904                      sub     cl, 4           ; Decrement shift amount
    55 00000032 49FFC9                      dec     r9
    56 00000035 75DD                        jnz     convert_loop    ; jne is on the allowed list
    57                                  
    58                                      ; Loop finishes after 16 iterations
    59                                      
    60 00000037 415C                        pop     r12
    61 00000039 5D                          pop     rbp
    62 0000003A C3                          ret
