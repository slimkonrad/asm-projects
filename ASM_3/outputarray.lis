     1                                  ;******************************************************************************************************************
     2                                  ;Program name: "Array Management".  This program demonstrates how to pass an array to a called subprogram.        *
     3                                  ;Copyright (C) 2020 Floyd Holliday                                                                                *
     4                                  ;                                                                                                                 *
     5                                  ;This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public*
     6                                  ;License version 3 as published by the Free Software Foundation.  This program is distributed in the hope that it *
     7                                  ;will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A  *
     8                                  ;PARTICULAR PURPOSE.  See the GNU General Public License for more details.  A copy of the GNU General Public      *
     9                                  ;License v3 is available here:  <https://www.gnu.org/licenses/>.                                                  *
    10                                  ;******************************************************************************************************************
    11                                  
    12                                  ;The blank line separates the notice of copyright (rights reserved to the author) from the notice of license 
    13                                  ;(rights reserved to the people).  The actual license itself never appears in source code but is type found in an
    14                                  ;accompanying text file.
    15                                  
    16                                  ;========1=========2=========3=========4=========5=========6=========7=========8=========9=========0=========1=========2
    17                                  ;
    18                                  ;Author information
    19                                  ;  Author name: Floyd Holliday
    20                                  ;  Author email: holliday@fullerton.edu
    21                                  ;
    22                                  ;Program information
    23                                  ;  Program name: Array Management
    24                                  ;  Programming languages: Two modules in C, two modules in X86
    25                                  ;  Date program began:     2022-Mar-04
    26                                  ;  Date program completed: 2022-Mar-06
    27                                  ;  Date comments upgraded: 2022-Mar-06
    28                                  ;  Files in this program: director.c, supervisor.asm, output_array.asm, input_array.c, director.c 
    29                                  ;  Status: Complete.  Alpha testing is finished.  Extreme cases were tested and errors resolved.
    30                                  ;
    31                                  ;References for this program
    32                                  ;  Jorgensen, X86-64 Assembly Language Programming with Ubuntu
    33                                  ;
    34                                  ;Purpose (academic)
    35                                  ;  Show how to pass an array from a caller function to a called function.
    36                                  ;
    37                                  ;This file
    38                                  ;   File name: output_array.asm
    39                                  ;   Language: i-series microprocessor assembly
    40                                  ;   Syntax: Intel
    41                                  ;   Max page width: 116 columns
    42                                  ;   Assemble: nasm -f elf64 -o super.o supervisor.asm -l super.lis
    43                                  ;   Link: gcc -m64 -no-pie -o arr.out -std=c17 director.o super.o input.o output.o 
    44                                  ;   Reference regarding -no-pie: Jorgensen, page 226.
    45                                  ;   Prototype of this function:  long showlumber(double * trees, long count);
    46                                  ;
    47                                  ;=======1=========2=========3=========4=========5=========6=========7=========8=========9=========0=========1=========2
    48                                  ;
    49                                  ;
    50                                  ;
    51                                  ;
    52                                  ;===== Begin code area ================================================================================================
    53                                  
    54                                  ;Declarations are collected together in this area
    55                                  default rel
    56                                  extern printf
    57                                  global outputarray
    58                                  
    59                                  segment .data
    60 00000000 25302E356C660A00        num_fmt db "%0.5lf", 10, 0        ; print a double then newline
    61                                  
    62                                  segment .text
    63                                  ; void outputarray(const double* arr, uint64_t n)
    64                                  ;   rdi = arr, rsi = n
    65                                  outputarray:
    66 00000000 55                          push    rbp
    67 00000001 4889E5                      mov     rbp, rsp
    68 00000004 4154                        push    r12
    69 00000006 4155                        push    r13
    70 00000008 4156                        push    r14
    71 0000000A 4883EC08                    sub     rsp, 8                ; keep rsp%16==8 before calls
    72                                  
    73 0000000E 4989FC                      mov     r12, rdi              ; arr base
    74 00000011 4989F5                      mov     r13, rsi              ; length
    75 00000014 4D31F6                      xor     r14, r14              ; i = 0
    76                                  
    77                                  .loop:
    78 00000017 4D39EE                      cmp     r14, r13
    79 0000001A 7D1C                        jge     .done
    80                                  
    81 0000001C F2430F1004F4                movsd   xmm0, [r12 + r14*8]   ; load arr[i] (double)
    82 00000022 488D3D(00000000)            lea     rdi, [rel num_fmt]    ; format string
    83 00000029 B801000000                  mov     eax, 1                ; 1 FP arg in xmm0 for printf
    84 0000002E E8(00000000)                call    printf
    85                                  
    86 00000033 49FFC6                      inc     r14
    87 00000036 EBDF                        jmp     .loop
    88                                  
    89                                  .done:
    90 00000038 4883C408                    add     rsp, 8
    91 0000003C 415E                        pop     r14
    92 0000003E 415D                        pop     r13
    93 00000040 415C                        pop     r12
    94 00000042 5D                          pop     rbp
    95 00000043 31C0                        xor     eax, eax              ; return 0
    96 00000045 C3                          ret
